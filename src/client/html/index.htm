<!doctype html>
<!--
/*
 * Copyright (c) 2016 Erik NordstrÃ¸m <erik@nordstroem.no>
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */
-->
<html lang=en-US>
<meta charset=UTF-8>
<title>Klondike</title>
<style>
body { background: #00f; }
#klondike { background: #0f0; }
</style>
<canvas id=klondike width=640 height=480></canvas>
<script>
var c = document.getElementById('klondike');
var ctx = c.getContext('2d');

var iid; // Interval id

var cw = 225; // Card width
var ch = 350; // Card height

var card = {};
card.value = 255;
card.x_last = 10;
card.y_last = 10;
card.x_cur = card.x_last;
card.y_cur = card.y_last;

var cursor = {};
cursor.x_down;
cursor.y_down;
cursor.dragging = false;
cursor.card = null;

function draw ()
{
	ctx.clearRect(0, 0, c.width, c.height);

	ctx.fillStyle = 'rgb(' + card.value + ',0,0)';
	ctx.fillRect(card.x_cur, card.y_cur, cw, ch);
}

function pick (e)
{
	var pixel = ctx.getImageData(e.layerX, e.layerY, 1, 1);
	var card_val = pixel.data[0];

	if (card_val && card_val != 94) // Card, not NULLCARD, not UNKNOWNCARD.
	{
		// TODO: Set cursor.card
		cursor.dragging = true;
		cursor.x_down = e.layerX;
		cursor.y_down = e.layerY;
		draw();
		iid = setInterval(draw, 16);
	}
}
c.addEventListener('mousedown', pick);

function transpose (e)
{
	if (cursor.dragging)
	{
		x_cur = card.x_last + (e.layerX - cursor.x_down);
		y_cur = card.y_last + (e.layerY - cursor.y_down);

		// Margins x
		x_cur = Math.max(0.1 * c.width - cw,
				Math.min(x_cur, 0.9 * c.width));
		// Margins y
		y_cur = Math.max(0.1 * c.height - ch,
				Math.min(y_cur, 0.9 * c.height));

		card.x_cur = x_cur;
		card.y_cur = y_cur;
	}
}
c.addEventListener('mousemove', transpose);

function place (e)
{
	cursor.dragging = false;
	card.x_last = card.x_cur;
	card.y_last = card.y_cur;
	draw();
	clearInterval(iid);
}
c.addEventListener('mouseup', place);
c.addEventListener('mouseout', place);

draw();
</script>
